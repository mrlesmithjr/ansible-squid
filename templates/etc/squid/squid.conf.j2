{{ ansible_managed|comment }}

{% if squid_dns_nameservers is defined %}
dns_nameservers {{ squid_dns_nameservers }}
{% endif %}

{% if squid_debug_options is defined %}
# Log verbosity
debug_options {{ squid_debug_options }}
{% endif %}

{% if squid_log_format is defined and squid_log_format != [] %}
# Log format
{%   for item in squid_log_format %}
logformat {{ item['name'] }} {{ item['format']}}
{%   endfor %}
{% endif %}

{% if squid_access_log is defined and squid_access_log != [] %}
# Access log location and format
{%   for item in squid_access_log %}
access_log {{ item['filename'] }} {{ item['format'] |default('squid')}}
{%   endfor %}
{% endif %}

{% if squid_auth_param is defined %}
# AUTH_PARAM
{%   for item in squid_auth_param %}
auth_param {{ item['name'] }} {{ item['type'] }} {{ item['arg']}}
{%   endfor %}
{% endif %}

{% if squid_acl is defined and squid_acl != [] %}
# ACLS
{%   for item in squid_acl %}
acl {{ item['name'] }} {{ item['type'] }} {{ item['arg'] }}
{%   endfor %}
{% endif %}

{% if squid_acl_localnet is defined and squid_acl_localnet != [] %}
# Local Networks
{%   for item in squid_acl_localnet %}
acl localnet src {{ item }}
{%   endfor %}
{% endif %}

{% if squid_acl_safeports is defined and squid_acl_safeports != [] %}
{%   for item in squid_acl_safeports %}
acl Safe_ports port {{ item['port'] }}{% if item['comment'] is defined %} #{{ item['comment'] }} {% endif %}

{%   endfor %}
{% endif %}

{% if squid_http_access is defined and squid_http_access != [] %}
{%   for item in squid_http_access %}
http_access {{ item['action'] }} {{ item['acl']|join(' ') }}
{%   endfor %}
{% endif %}

{% if squid_refresh_patterns is defined and squid_refresh_patterns != [] %}
{%   for item in squid_refresh_patterns %}
refresh_pattern {{ item['regex'] }} {{ item['min'] }} {{ item['percent'] }} {{ item['max'] }}
{%   endfor %}
{% endif %}

# HTTP
http_port {{ squid_http.port }} {% if squid_http.options is defined %}{{ squid_http.options }}{% endif %}
{% if squid_http.intercept is defined and squid_http.intercept %}

http_port {{ squid_http.intercept_port }} intercept
{% endif %}

# HTTPS
{% if squid_https is defined and squid_https.enabled %}
https_port {{ squid_https.port }} {% if squid_https.intercept %}intercept{% endif %} {% if squid_https.ssl_bump %}ssl-bump{% endif %} generate-host-certificates={{ squid_https.generate_host_certificates}} dynamic_cert_mem_cache_size={{ squid_https.dynamic_cert_mem_cache_size }} tls-cert={{ squid_https.tls_cert_path }} tls-key={{ squid_https.tls_key_path }}
{% endif %}

# SSL BUMP
{% if squid_ssl_bump is defined and squid_ssl_bump != [] %}
{%   for item in squid_ssl_bump %}
ssl_bump {{ item['action'] }} {{ item['acl'] }}
{%   endfor %}

# SSL certificate generation
sslcrtd_program {{ squid_sslcrtd_program }}
sslcrtd_children {{ squid_sslcrtd_children }}
{% endif %}

# CACHE PEERING
{% if squid_cache_peering %}
icp_access allow {{ squid_icp_access }}
icp_port {{ squid_icp_port }}
{% endif %}
{% if squid_cache_peer != [] %}
{%   for item in squid_cache_peer %}
{%     if item.host != ansible_hostname and item.domain is defined %}
cache_peer {{ item.host }}.{{ item.domain}} {{ item.type }} {{ item.proxy_port}} {{ item.icp_port }} {{ item.options }}
{%     elif item.host != ansible_hostname and item.domain is not defined %}
cache_peer {{ item.host }} {{ item.type }} {{ item.proxy_port}} {{ item.icp_port }} {{ item.options }}
{%     endif %}
{%   endfor %}
{% endif %}

{% if squid_never_direct != [] %}
# NEVER DIRECT
{%   for item in squid_never_direct %}
never_direct {{ item['action'] }} {{ item['acl'] }}
{% endfor %}
{% endif %}

{% if squid_always_direct != [] %}
# ALWAYS DIRECT
{%   for item in squid_always_direct %}
always_direct {{ item['action'] }} {{ item['acl'] }}
{% endfor %}
{% endif %}

{% if squid_shutdown_lifetime is defined %}
shutdown_lifetime {{ squid_shutdown_lifetime }}
{% endif %}

{% if (squid_suppress_version is defined and squid_suppress_version) or squid_suppress_version is not defined %}
httpd_suppress_version_string on
{% endif %}
